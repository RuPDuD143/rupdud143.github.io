<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>KAHEL Miner Game â€” Miner UI (Frontend)</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --card: #111;
      --accent: #ff6600;
      --muted: #bbb;
      --fg: #fff;
    }
    html,body { height:100%; margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--fg); }
    .layout { display:flex; height:100vh; gap:16px; padding:16px; box-sizing:border-box; }
    .miner-panel {
      width:420px;
      background:var(--card);
      border-radius:12px;
      padding:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .miner-img { width:200px; height:200px; object-fit:cover; border-radius:8px; background:#222; }
    .label { margin-top:12px; font-size:0.95rem; color:var(--muted); width:100%; display:flex; justify-content:space-between; }
    .big { font-size:1.25rem; color:var(--fg); margin-top:8px; }
    .controls { margin-top:14px; display:flex; gap:8px; }
    button { background:var(--accent); border:none; color:white; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    button.secondary { background:#444; }
    input[type="number"], input[type="text"] { padding:8px; border-radius:6px; border:1px solid #333; background:#0f0f0f; color:var(--fg); width:160px; }
    .right-col { flex:1; display:flex; flex-direction:column; gap:12px; }
    .submit-area {
      background:var(--card);
      border-radius:12px;
      padding:16px;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .submit-area h2 { margin:0; color:var(--accent); }
    .submit-row { display:flex; gap:8px; align-items:center; }
    .note { font-size:0.85rem; color:var(--muted); }
    .right-bottom {
      background:var(--card);
      border-radius:12px;
      padding:12px 18px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-sizing:border-box;
    }
    .stat { font-size:1.05rem; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .status { color:#cfcfcf; font-size:0.95rem; margin-top:8px; height:20px;}
    .small { font-size:0.9rem; color:var(--muted); }
  </style>
</head>
<body>
  <div class="layout">
    <div class="miner-panel"> 
      <img src="miner.png" alt="Miner" class="miner-img" id="minerImg" /> 
      <div class="label">
        <span class="small">Account:</span>
        <span id="accountDisplay">Not logged in</span>
      </div> 
      <div class="label">
        <span>Miner Level</span>
        <span id="minerLevel">0</span>
      </div> 
      <div class="label">
        <span>Mined Coins</span>
        <span id="minedCoins">0</span>
      </div> 
      <div class="label">
        <span>Coin Rate (per min)</span>
        <span id="coinRate">0</span>
      </div> <div class="label">
        <span>Cap</span>
        <span id="minerCap">0</span>
      </div> <div class="controls"> 
        <button id="upgradeBtn">Upgrade Miner</button> 
        <button id="takeBtn" class="secondary">Take Coins</button> 
      </div> <div style="width:100%; margin-top:10px; text-align:left;"> 
        <div class="note">Miner generates coins locally (front-end) once per minute. When mined coins reach cap, generation pauses until you press <strong>Take Coins</strong>.</div> 
        <div class="status" id="status">Not logged in.</div> 
      </div> <div style="margin-top:auto; width:100%; text-align:left;"> 
        <div style="margin-top:12px;"> 
          <button id="loginBtn">Login (MyCloudWallet / WAX)</button> 
          <button id="logoutBtn" style="display:none" class="secondary">Logout</button> 
        </div> 
      </div> 
    </div>
    

    <div class="right-col">
      <div class="submit-area">
        <div class="topbar">
          <h2>Submit Coins for a Share of the Gem Pool</h2>
          <div class="small">Submissions reset every UTC day</div>
        </div>
        <div class="stats">
          <div class="label"><span>Total Gem Reward Pool</span><span id="poolGems">1000</span></div>
          <div class="label"><span>Total Coin Submissions</span><span id="totalSubmits">0</span></div>
          <div class="label"><span>Your Coin Submission</span><span id="yourSubmit">0</span></div>
          <div class="label"><span>Your Approx. Share</span><span id="yourShare">0</span></div>
        </div>
        <hr style="border:none;border-top:1px solid #333;margin:10px 0;">
        <div id="submitSection">
          <div class="submit-row">
            <input id="submitAmt" type="number" placeholder="Minimum: 10" min="10" />
            <button id="submitBtn">Submit Coins</button>
          </div>
          <div class="note" id="submitNote">Submit at least 10 coins to join today's Gem Pool.</div>
        </div>
        <div style="margin-top:auto;">
          <div class="note">Server: <span id="serverUrl"></span></div>
        </div>
      </div>


      <div class="right-bottom">
        <div>
          <div class="stat">Coins: <strong id="navCoins">0</strong></div>
        </div>
        <div>
          <div class="stat">Gems: <strong id="navGems">0</strong></div>
        </div>
      </div>
    </div>
  </div>

  <script src="waxjs.js"></script>
  <script>
    const BACKEND = 'https://rupdud143backend.onrender.com';
    document.getElementById('serverUrl').textContent = BACKEND;

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const accountDisplay = document.getElementById('accountDisplay');
    const statusEl = document.getElementById('status');
    const minerLevelEl = document.getElementById('minerLevel');
    const minedCoinsEl = document.getElementById('minedCoins');
    const coinRateEl = document.getElementById('coinRate');
    const minerCapEl = document.getElementById('minerCap');
    const upgradeBtn = document.getElementById('upgradeBtn');
    const takeBtn = document.getElementById('takeBtn');
    const submitAmt = document.getElementById('submitAmt');
    const submitBtn = document.getElementById('submitBtn');
    const submitSection = document.getElementById('submitSection');
    const submitNote = document.getElementById('submitNote');
    const navCoins = document.getElementById('navCoins');
    const navGems = document.getElementById('navGems');
    const totalSubmits = document.getElementById('totalSubmits');
    const yourSubmit = document.getElementById('yourSubmit');
    const yourShare = document.getElementById('yourShare');
    const poolGems = document.getElementById('poolGems');

    const wax = new waxjs.WaxJS({ rpcEndpoint: 'https://wax.greymass.com', tryAutoLogin: false });
    let myAccount = null;

    let minerLevel = 0, minedCoins = 0, minerCap = 0, coinRate = 0, minerTimer = null;

    function setStatus(msg, err=false){ statusEl.textContent=msg; statusEl.style.color=err?'#ff8080':'#cfcfcf'; }
    function computeRateAndCap(){ coinRate=(minerLevel||0)*10; minerCap=(minerLevel||0)*100; coinRateEl.textContent=coinRate; minerCapEl.textContent=minerCap; }
    function refreshMinedDisplay(){ minedCoinsEl.textContent=minedCoins.toFixed(2); }
    function refreshRightStats(d){ navCoins.textContent=d.coins||0; navGems.textContent=d.gems||0; }

    async function fetchPlayer() {
      if (!myAccount) return;
      try {
        const r = await fetch(`${BACKEND}/player/${myAccount}`);
        const d = await r.json();
        if (!r.ok) {
          setStatus('Fetch player failed: ' + d.error, true);
          return;
        }
    
        // âœ… Miner level as before
        minerLevel = d.miner_level || 0;
        minerLevelEl.textContent = minerLevel;
    
        // âœ… New: Handle NFT info and rates
        const nftName = d.strongest_nft?.name || "Basic Miner";
        const nftRate = d.mining_rate || 1; // rate per second from backend
        const nftCap = nftRate * 60 * 10;   // rate/min Ã— 10
    
        // Update UI
        document.getElementById("minerName").textContent = nftName;
        document.getElementById("coinRate").textContent = (nftRate * 60).toLocaleString();
        document.getElementById("minerCap").textContent = nftCap.toLocaleString();
    
        // Replace old computeRateAndCap (weâ€™ll override cap and rate manually)
        miningRate = nftRate;   // per second
        minerCap = nftCap;
    
        refreshRightStats(d);
    
        if (minedCoins > minerCap) minedCoins = minerCap;
        refreshMinedDisplay();
    
        setStatus('Player data loaded.');
        await fetchPool(); // ðŸ”¹ fetch pool after player
      } catch (e) {
        setStatus('Network error: ' + e.message, true);
      }
    }


    async function fetchPool(){
      if(!myAccount)return;
      try{
        const r=await fetch(`${BACKEND}/pool/${myAccount}`); const d=await r.json();
        if(!r.ok){console.error(d);return;}
        totalSubmits.textContent=d.total_submissions;
        yourSubmit.textContent=d.user_submission;
        yourShare.textContent=d.user_approx_share;
        if(d.user_submission>=10){
          submitSection.style.display='none';
          submitNote.textContent="You've already joined today's Gem Pool.";
        }else{
          submitSection.style.display='block';
          submitNote.textContent='Submit at least 15,000 coins to join today\'s Gem Pool.';
        }
      }catch(e){console.warn('pool error',e);}
    }

    // miner loop
    function startMiner(){ if(minerTimer)clearInterval(minerTimer); minerTimer=setInterval(minerTick,1000); setStatus('Miner started.'); }
    function stopMiner(){ if(minerTimer){clearInterval(minerTimer); minerTimer=null;} }
    function minerTick(){ if(!minerLevel||coinRate<=0)return; if(minedCoins>=minerCap){setStatus('Miner full. Take coins.');return;}
      const add=(minerLevel*10)/60; minedCoins=Math.min(minerCap, minedCoins+add); minedCoins=Math.floor(minedCoins*100)/100; refreshMinedDisplay();
      if(minedCoins>=minerCap)setStatus('Miner reached cap. Take coins.');
    }

    // buttons
    takeBtn.onclick=async()=>{ if(!myAccount)return setStatus('Login first',true);
      if(minedCoins<=0)return setStatus('No mined coins',true);
      setStatus('Taking coins...');
      const r=await fetch(`${BACKEND}/take`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({account:myAccount,amount:Math.floor(minedCoins)})});
      const d=await r.json(); if(!r.ok)return setStatus('Take failed: '+d.error,true);
      minedCoins=0; refreshMinedDisplay(); await fetchPlayer(); setStatus('Coins taken.');
    };

    upgradeBtn.onclick=async()=>{ if(!myAccount)return setStatus('Login first',true);
      setStatus('Upgrading...');
      const r=await fetch(`${BACKEND}/upgrade`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({account:myAccount})});
      const d=await r.json(); if(!r.ok)return setStatus('Upgrade failed: '+d.error,true);
      await fetchPlayer(); setStatus('Upgraded to '+d.new_level);
    };

    submitBtn.onclick=async()=>{
      if(!myAccount)return setStatus('Login first',true);
      const amt=Math.floor(Number(submitAmt.value||0));
      if(amt<10)return setStatus('Minimum 10 coins',true);
      setStatus('Submitting...');
      const r=await fetch(`${BACKEND}/submit`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({account:myAccount,amount:amt})});
      const d=await r.json(); if(!r.ok)return setStatus('Submit failed: '+d.error,true);
      setStatus('Submitted '+d.submitted+' coins.'); submitAmt.value=''; await fetchPlayer();
    };

    

    loginBtn.onclick=async()=>{
      try{
        const a=await wax.login(); myAccount=a; accountDisplay.textContent=a; loginBtn.style.display='none'; logoutBtn.style.display='inline-block';
        setStatus('Logged in.'); await fetchPlayer(); startMiner();
      }catch(e){setStatus('Login failed: '+e.message,true);}
    };
    logoutBtn.onclick=()=>{ try{if(wax&&wax.logout)wax.logout();}catch(e){} myAccount=null; accountDisplay.textContent='Not logged in';
      loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; stopMiner(); setStatus('Logged out.');
    };

    document.addEventListener('visibilitychange',()=>{ if(document.hidden){stopMiner();setStatus('Miner paused.');}
      else if(myAccount){setStatus('Resumed.');startMiner();fetchPlayer();}
    });

    (function init(){ computeRateAndCap(); refreshMinedDisplay(); setStatus('Ready. Login to start.'); })();
  </script>
</body>
</html>

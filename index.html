<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>KAHEL Miner Game — Miner UI (Frontend)</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --card: #111;
      --accent: #ff6600;
      --muted: #bbb;
      --fg: #fff;
    }
    html,body { height:100%; margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--fg); }
    .layout { display:flex; height:100vh; gap:16px; padding:16px; box-sizing:border-box; }
    /* left: miner panel (full height) */
    .miner-panel {
      width:420px;
      background:var(--card);
      border-radius:12px;
      padding:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .miner-img { width:200px; height:200px; object-fit:cover; border-radius:8px; background:#222; }
    .label { margin-top:12px; font-size:0.95rem; color:var(--muted); width:100%; display:flex; justify-content:space-between; }
    .big { font-size:1.25rem; color:var(--fg); margin-top:8px; }
    .controls { margin-top:14px; display:flex; gap:8px; }
    button { background:var(--accent); border:none; color:white; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    button.secondary { background:#444; }
    input[type="number"], input[type="text"] { padding:8px; border-radius:6px; border:1px solid #333; background:#0f0f0f; color:var(--fg); width:160px; }
    /* right: vertical flexible area */
    .right-col { flex:1; display:flex; flex-direction:column; gap:12px; }
    .submit-area {
      background:var(--card);
      border-radius:12px;
      padding:16px;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .submit-area h2 { margin:0; color:var(--accent); }
    .submit-row { display:flex; gap:8px; align-items:center; }
    .note { font-size:0.85rem; color:var(--muted); }
    /* bottom navbar (right side) */
    .right-bottom {
      height:76px;
      background:var(--card);
      border-radius:12px;
      padding:12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-sizing:border-box;
    }
    .stat { font-size:1.05rem; }
    .topbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .status { color:#cfcfcf; font-size:0.95rem; margin-top:8px; height:20px;}
    .small { font-size:0.9rem; color:var(--muted); }
  </style>
</head>
<body>
  <div class="layout">
    <div class="miner-panel">
      <img src="miner.png" alt="Miner" class="miner-img" id="minerImg" />
      <div class="label"><span class="small">Account:</span><span id="accountDisplay">Not logged in</span></div>

      <div class="label"><span>Miner Level</span><span id="minerLevel">0</span></div>
      <div class="label"><span>Mined Coins</span><span id="minedCoins">0</span></div>
      <div class="label"><span>Coin Rate (per min)</span><span id="coinRate">0</span></div>
      <div class="label"><span>Cap</span><span id="minerCap">0</span></div>

      <div class="controls">
        <button id="upgradeBtn">Upgrade Miner</button>
        <button id="takeBtn" class="secondary">Take Coins</button>
      </div>

      <div style="width:100%; margin-top:10px; text-align:left;">
        <div class="note">Miner generates coins locally (front-end) once per minute. When mined coins reach cap, generation pauses until you press <strong>Take Coins</strong>.</div>
        <div class="status" id="status">Not logged in.</div>
      </div>

      <div style="margin-top:auto; width:100%; text-align:left;">
        <div style="margin-top:12px;">
          <button id="loginBtn">Login (MyCloudWallet / WAX)</button>
          <button id="logoutBtn" style="display:none" class="secondary">Logout</button>
        </div>
      </div>
    </div>

    <div class="right-col">
      <div class="submit-area">
        <div class="topbar">
          <h2>Submit Coins for Gems Share</h2>
          <div class="small">Submissions recorded per UTC day</div>
        </div>

        <div>
          <div class="label"><span>Current Coins</span><span id="rightCoins">0</span></div>
          <div class="label"><span>Current Gems</span><span id="rightGems">0</span></div>
        </div>

        <div style="margin-top:12px;">
          <div class="submit-row">
            <input id="submitAmt" type="number" placeholder="Amount of coins to submit" min="1" />
            <button id="submitBtn">Submit for Gems Share</button>
            <button id="cashoutBtn" class="secondary">Cashout 1000 Gems → 1 KAHEL</button>
          </div>
          <div class="note">Submitting coins records them into today's pool. Gems will be distributed later by admin logic (or manual payout).</div>
        </div>

        <div style="margin-top:6px;">
          <div class="note">Tip: Miner produces coins locally. Press <strong>Take Coins</strong> to transfer mined coins to your account (server).</div>
        </div>

        <div style="margin-top:auto;">
          <div class="note">Server: <span id="serverUrl"></span></div>
        </div>
      </div>

      <div class="right-bottom">
        <div>
          <div class="stat">Coins: <strong id="navCoins">0</strong></div>
        </div>
        <div>
          <div class="stat">Gems: <strong id="navGems">0</strong></div>
        </div>
      </div>
    </div>
  </div>

  <script src="waxjs.js"></script>
  <script>
    // CONFIG
    const BACKEND = 'https://rupdud143backend.onrender.com'; // change if needed
    document.getElementById('serverUrl').textContent = BACKEND;

    // DOM
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const accountDisplay = document.getElementById('accountDisplay');
    const statusEl = document.getElementById('status');

    const minerLevelEl = document.getElementById('minerLevel');
    const minedCoinsEl = document.getElementById('minedCoins');
    const coinRateEl = document.getElementById('coinRate');
    const minerCapEl = document.getElementById('minerCap');

    const upgradeBtn = document.getElementById('upgradeBtn');
    const takeBtn = document.getElementById('takeBtn');

    const submitAmt = document.getElementById('submitAmt');
    const submitBtn = document.getElementById('submitBtn');
    const cashoutBtn = document.getElementById('cashoutBtn');

    const rightCoins = document.getElementById('rightCoins');
    const rightGems = document.getElementById('rightGems');
    const navCoins = document.getElementById('navCoins');
    const navGems = document.getElementById('navGems');

    // WAX login (local waxjs)
    const wax = new waxjs.WaxJS({ rpcEndpoint: 'https://wax.greymass.com', tryAutoLogin: false });

    let myAccount = null;

    // Miner front-end state
    let minerLevel = 0;
    let minedCoins = 0;
    let minerCap = 0;
    let coinRate = 0; // coins per minute
    let minerTimer = null;

    function setStatus(msg, err=false) {
      statusEl.textContent = msg;
      statusEl.style.color = err ? '#ff8080' : '#cfcfcf';
    }

    function computeRateAndCap() {
      coinRate = (minerLevel || 0) * 10; // per minute
      minerCap = (minerLevel || 0) * 100;
      coinRateEl.textContent = coinRate;
      minerCapEl.textContent = minerCap;
    }

    // UI updater
    function refreshMinedDisplay() {
      minedCoinsEl.textContent = minedCoins.toFixed(2);
    }
    function refreshRightStats(data) {
      rightCoins.textContent = data.coins || 0;
      rightGems.textContent = data.gems || 0;
      navCoins.textContent = data.coins || 0;
      navGems.textContent = data.gems || 0;
    }

    // fetch player
    async function fetchPlayer() {
      if (!myAccount) return;
      try {
        const resp = await fetch(`${BACKEND}/player/${myAccount}`);
        const data = await resp.json();
        if (!resp.ok) {
          setStatus('Error fetching player: ' + (data.error || JSON.stringify(data)), true);
          return;
        }
        console.log(data.miner_level);
        minerLevel = data.miner_level || 0;
        minerLevelEl.textContent = minerLevel;
        computeRateAndCap();
        refreshRightStats(data);
        // ensure minedCoins doesn't exceed cap (if someone changed level)
        if (minedCoins > minerCap) minedCoins = minerCap;
        refreshMinedDisplay();
        setStatus('Player data loaded.');
        console.log("player set");
      } catch (e) {
        setStatus('Network error: ' + e.message, true);
      }
    }

    // Miner loop: runs on frontend, once per minute
    function startMiner() {
      if (minerTimer) clearInterval(minerTimer);
      minerTimer = setInterval(minerTick, 1000); // once per second
      setStatus('Miner started. Mining every second.');
    }
    function stopMiner() {
      if (minerTimer) { clearInterval(minerTimer); minerTimer = null; }
    }
    // Adds (miner_level * 10) / 60 coins per second, rounded to 2 decimals
    function minerTick() {
      if (!minerLevel || coinRate <= 0) return;
      if (minedCoins >= minerCap) {
        setStatus('Miner is full. Press Take Coins to collect.', false);
        return;
      }
    
      const add = (minerLevel * 10) / 60; // per second
      minedCoins = Math.min(minerCap, minedCoins + add);
    
      // Round down to 2 decimals
      minedCoins = Math.floor(minedCoins * 100) / 100;
    
      refreshMinedDisplay();
    
      if (minedCoins >= minerCap) {
        setStatus('Miner reached cap. Press Take Coins to collect.', false);
      }
    }

    // Take coins: send mined coins to server to add into user's coins
    takeBtn.addEventListener('click', async () => {
      if (!myAccount) { setStatus('Login first.', true); return; }
      if (!minedCoins || minedCoins <= 0) { setStatus('No mined coins to take.', true); return; }
      setStatus('Sending mined coins to server...');
      try {
        const resp = await fetch(`${BACKEND}/take`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ account: myAccount, amount: Math.floor(minedCoins) })
        });
        const data = await resp.json();
        if (!resp.ok) { setStatus('Take failed: ' + (data.error || JSON.stringify(data)), true); return; }
        setStatus(`Taken ${data.added} coins. Server coins: ${data.coins}`);
        minedCoins = 0;
        refreshMinedDisplay();
        await fetchPlayer();
      } catch (e) {
        setStatus('Network error: ' + e.message, true);
      }
    });

    // Upgrade miner
    upgradeBtn.addEventListener('click', async () => {
      if (!myAccount) { setStatus('Login first.', true); return; }
      setStatus('Upgrading miner...');
      try {
        const resp = await fetch(`${BACKEND}/upgrade`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ account: myAccount })
        });
        const data = await resp.json();
        if (!resp.ok) { setStatus('Upgrade failed: ' + (data.error || JSON.stringify(data)), true); return; }
        setStatus(`Upgraded to level ${data.new_level}.`);
        await fetchPlayer();
      } catch (e) {
        setStatus('Network error: ' + e.message, true);
      }
    });

    // Submit coins to daily pool
    submitBtn.addEventListener('click', async () => {
      if (!myAccount) { setStatus('Login first.', true); return; }
      const amt = Math.floor(Number(submitAmt.value || 0));
      if (!amt || amt <= 0) { setStatus('Enter amount > 0', true); return; }
      setStatus('Submitting coins...');
      try {
        const resp = await fetch(`${BACKEND}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ account: myAccount, amount: amt })
        });
        const data = await resp.json();
        if (!resp.ok) { setStatus('Submit failed: ' + (data.error || JSON.stringify(data)), true); return; }
        setStatus(`Submitted ${data.submitted} coins for today.`);
        submitAmt.value = '';
        await fetchPlayer();
      } catch (e) {
        setStatus('Network error: ' + e.message, true);
      }
    });

    // Cashout (1000 gems -> 1 KAHEL) - kept as simple server endpoint (server should be configured)
    cashoutBtn.addEventListener('click', async () => {
      if (!myAccount) { setStatus('Login first.', true); return; }
      setStatus('Requesting cashout...');
      try {
        const resp = await fetch(`${BACKEND}/cashout`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ account: myAccount, gems_to_cashout: 1000 })
        });
        const data = await resp.json();
        if (!resp.ok) { setStatus('Cashout failed: ' + (data.error || JSON.stringify(data)), true); return; }
        setStatus(`Cashout success. Tx: ${data.txid || 'unknown'}`);
        await fetchPlayer();
      } catch (e) {
        setStatus('Network error: ' + e.message, true);
      }
    });

    // Login/logout
    loginBtn.addEventListener('click', async () => {
      try {
        const userAccount = await wax.login();
        myAccount = userAccount;
        accountDisplay.textContent = myAccount;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        setStatus('Logged in. Fetching player...');
        await fetchPlayer();
        startMiner();
      } catch (e) {
        setStatus('Login failed: ' + (e.message || e), true);
      }
    });
    logoutBtn.addEventListener('click', () => {
      try { if (wax && wax.logout) wax.logout(); } catch(e){}
      myAccount = null;
      accountDisplay.textContent = 'Not logged in';
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      stopMiner();
      setStatus('Logged out.');
    });

    // visibility handling - pause miner when tab hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopMiner();
        setStatus('Tab hidden: miner paused.');
      } else {
        if (myAccount) {
          setStatus('Tab active: miner resumed.');
          startMiner();
          fetchPlayer();
        }
      }
    });

    // init
    (function init(){
      // initial UI
      minerLevel = 0;
      computeRateAndCap();
      refreshMinedDisplay();
      setStatus('Ready. Login to start.');
    })();
  </script>
</body>
</html>
